# debug

* 代码不能完全按照您的想法运行，它只能完全按照您的写法运行

## 调试代码

* 最有效的 debug 工具就是细致的分析，配合恰当位置的打印语句
* 在发现问题的地方添加一些打印语句，然后不断重复此过程直到获取了足够的信息并找到问题的根本原因
* 使用日志
  - 可以将日志写入文件、socket 或者甚至是发送到远端服务器而不仅仅是标准输出；
  - 日志可以支持严重等级（例如 INFO, DEBUG, WARN, ERROR等)，这使您可以根据需要过滤日志；
  - 对于新发现的问题，很可能日志中已经包含了可以帮助定位问题的足够的信息。

## 第三方日志系统

* 大多数的程序都会将日志保存在系统中的某个地方
* 系统开始使用 system log，所有的日志都会保存在这里。大多数的（但不是全部）Linux 系统都会使用 systemd，这是一个系统守护进程，会控制系统中的很多东西
  - systemd 会将日志以某种特殊格式存放于/var/log/journal，您可以使用 journalctl 命令显示这些消息
  - 在 macOS 系统中是 /var/log/system.log，但是有更多的工具会使用系统日志，内容可以使用 log show 显示
  - 大多数的编程语言都支持向系统日志中写日志

```sh
logger "Hello Logs"
# On macOS
log show --last 1m | grep Hello
# On Linux
journalctl --since "1m ago" | grep Hello
```

## 调试器

* 作用
  - 当到达某一行时将程序暂停；
  - 一次一条指令地逐步执行程序；
  - 程序崩溃后查看变量的值；
  - 满足特定条件是暂停程序；

## 静态分析 code linting

* [awesome-static-analysis](https://github.com/mre/awesome-static-analysis)

## 性能分析

* 执行时间（wall clock time）:两处代码之间的时间
  - 用户时间+系统时间代表了您的进程所消耗的实际 CPU
  - 真实时间 - 从程序开始到结束流失掉到真实时间，包括其他进程到执行时间以及阻塞消耗的时间（例如等待 I/O或网络）；
  - User - CPU 执行用户代码所花费的时间；
  - Sys - CPU 执行系统内核代码所花费的时间。
* 性能分析工具（profilers）
  - CPU
    + 追踪分析器（tracing）会记录程序的每一次函数调用
    + 采样分析器（sampling）会周期性的监测（通常为每毫秒）程序并记录程序堆栈
  - 内存
    + 使用类似 Valgrind 这样的工具来检查内存泄漏问题。
  - 事件分析
    + 显示 CPU 分析数据的形式是 火焰图，火焰图会在 Y 轴显示函数调用关系，并在 X 轴显示其耗时的比例
    + 调用图和控制流图可以显示子程序之间的关系，它将函数作为节点并把函数调用作为边。将它们和分析器的信息（例如调用次数、耗时等）放在一起使用时，调用图会变得非常有用，它可以帮助我们分析程序的流程
* 资源监控
  - 通用监控
    + 最流行的工具要数 htop,了，它是 top的改进版。htop 可以显示当前运行进程的多种统计信息。htop 有很多选项和快捷键，常见的有：`<F6>` 进程排序、 t 显示树状结构和 h 打开或折叠线程。
    + 还可以留意一下 glances ，它的实现类似但是用户界面更好。如果需要合并测量全部的进程， dstat 是也是一个非常好用的工具，它可以实时地计算不同子系统资源的度量数据，例如 I/O、网络、 CPU 利用率、上下文切换等等；
  - I/O 操作 - iotop 可以显示实时 I/O 占用信息而且可以非常方便地检查某个进程是否正在执行大量的磁盘读写操作；
  - 磁盘使用
    + df 可以显示每个分区的信息
    + du 则可以显示当前目录下每个文件的磁盘使用情况（ disk usage）。-h 选项可以使命令使用对人类（human）更加友好的格式显示数据；
    + ncdu是一个交互性更好的 du ，它可以让您在不同目录下导航、删除文件和文件夹；
  - 内存使用 - free 可以显示系统当前空闲的内存。内存也可以使用 htop 这样的工具来显示；
  - 打开文件 - lsof 可以列出被进程打开的文件信息。 当我们需要查看某个文件是被哪个进程打开的时候，这个命令非常有用；.
  - 网络连接和配置
    + ss le帮助监控网络包的收发情况以及网络接口的显示信息。ss 常见的一个使用场景是找到端口被进程占用的信息。
    + 如果要显示路由、网络设备和接口信息，可以使用 ip 命令。注意，netstat 和 ifconfig 这两个命令已经被前面那些工具所代替了。
  - 网络使用 - nethogs 和 iftop 是非常好的用于对网络占用进行监控的交互式命令行工具。
    + [stress](https://linux.die.net/man/1/stress)为系统人为地增加负载

```sh
time curl https://missing.csail.mit.edu &> /dev/null`

python -m memory_profiler example.py
```
