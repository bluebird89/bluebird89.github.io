# 趣谈网络协议

* 所有不能表示出层层封装含义的比喻，都是不恰当的
* **只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层**
* 对 TCP 协议来说，三次握手也好，重试也好，只要想发出去包，就要有 IP 层和 MAC 层，不然是发不出去的
* 下层是上层实现的基础，，下层要包含上层的语义

* 一个 HTTP 协议的包经过一个二层设备，二层设备收进去的是整个网络包。这里面 HTTP、TCP、 IP、 MAC 都有

## 二层设备 数据链路层

* 只把 MAC 头摘下来，看看到底是丢弃、转发，还是自己留着

## 三层设备 网络层

* 把 MAC 头摘下来之后，再把 IP 头摘下来，看看到底是丢弃、转发，还是自己留着

* IP 是地址，有定位功能
* MAC 是身份证，无定位功能
* 无类型域间选路 CIDR:判断是不是本地地址
    - 打破了原来设计的几类地址做法，将 32 位的 IP 地址一分为二，前面是网络号，后面是主机号。从哪里分呢？
    - 表示形式 10.100.122.2/24：斜杠后面有个数字 24，前 24 位是网络号，后 8 位是主机号
    - 广播地址，10.100.122.255。如果发送这个地址，所有 10.100.122 网络里面的机器都可以收到
    - 子网掩码，255.255.255.0
    - 将子网掩码和 IP 地址按位计算 AND，就可得到网络号

* 整个网络里面的第一个地址 192.168.0.1，往往就是私有网络的出口地址

* net_device flags 网络设备的状态标识
    - UP 表示网卡处于启动的状态
    - BROADCAST 表示这个网卡有广播地址，可以发送广播包
    - MULTICAST 表示网卡可以发送多播包
    - LOWER_UP 表示 L1 是启动的，也即网线插着呢
* MTU 是二层 MAC 层的概念。MAC 层有 MAC 的头，以太网规定连 MAC 头带正文合起来，不允许超过 1500 个字节
    - 正文里面有 IP 的头、TCP 的头、HTTP 的头。如果放不下，就需要分片来传输
* qdisc queueing discipline 排队规则:内核如果需要通过某个网络接口发送数据包，都需要按照为这个接口配置的 qdisc（排队规则）把数据包加入队列
    - 最简单的 是 pfifo，不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列
    - pfifo_fast 稍微复杂一些，它的队列包括三个波段（band）。在每个波段里面，使用先进先出规则
        + 数据包按照服务类型（Type of Service，TOS）被分配到三个波段（band）里面的。TOS 是 IP 头里面的一个字段，代表了当前的包是高优先级的，还是低优先级的
        + 三个波段（band）的优先级也不相同。band 0 的优先级最高，band 2 的最低
        + 如果 band 0 里面有数据包，系统就不会处理 band 1 里面的数据包，band 1 和 band 2 之间也是一样

* 只有是一个网段的，它才会发送 ARP 请求，获取 MAC 地址
* Linux 默认的逻辑是，如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关
* 配置了网关的话，Linux 会获取网关的 MAC 地址，然后将包发出去
* 没有配置网关呢？那包压根就发不出去
* 网关要和当前的网络至少一个网卡是同一个网段的
*

```sh
ip addr

1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff
    inet 10.100.122.2/24 brd 10.100.122.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fec7:7975/64 scope link
       valid_lft forever preferred_lft forever
```


## 网关

* 转发网关：不改变 IP 地址的网关
* NAT 网关：改变 IP 地址的网关

穿透

[BBR](https://queue.acm.org/detail.cfm?id=3022184)
