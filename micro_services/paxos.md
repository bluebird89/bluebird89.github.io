# Paxos

* Google Chubby的作者Mike Burrows 《Paxos Made Simple》
* Paxos问题指分布式系统中存在故障fault，但不存在恶意corrupt节点场景（消息可能丢失但不会造假）下的共识达成（Consensus）问题
* 第一个被证明的共识算法，原理基于两阶段提交并进行扩展。算法中将节点分为三种类型：
  - 倡议者proposer：提交一个提案，等待大家批准为结案，往往是客户端担任。
  - 接受者acceptor：负责对提案进行投票，往往服务器担任。提议超过半数的接受者投票及被选中。
  - 学习者learner：被告知提案结果，并与之统一，不参与投票过程。客户端和服务端都可担任
* 目标：保证最终有一个提案会被选定，当提案被选定后，其他议员最终也能获取到被选定的提案。
* 特点
  - 一个或多个节点可以提出提议
  - 系统针对所有提案中的某个提案必须达成一致
  - 最多只能对一个确定的提案达成一致。•只要超过半数的节点存活且可互相通信，整个系统一定能达成一致状态

## 流程

* 第一阶段
  - Proposer选择一个提议编号n，向所有的Acceptor广播Prepare（n）请求
  - Acceptor接收到Prepare（n）请求，若提议编号n比之前接收的Prepare请求都要大，则承诺将不会接收提议编号比n小的提议，并且带上之前Accept的提议中编号小于n的最大的提议，否则不予理会
* 第二阶段
  - Proposer得到了多数Acceptor的承诺后，如果没有发现有一个Acceptor接受过一个值，那么向所有的Acceptor发起自己的值和提议编号n，否则，从所有接受过的值中选择对应的提议编号最大的，作为提议的值，提议编号仍然为n
  - Acceptor接收到提议后，如果该提议编号不违反自己做过的承诺，则接受该提议

## 实例

* 在 Paxos 岛上，有A1, A2, A3, A4, A5 5位议员，就税率问题进行决议
* A1 说：税率应该是 10%。而此时只有他一个人提这个建议
  - 没有任何人和他竞争提案，他的这个提案毫无阻挠的通过了，A2 - A5 都会回应他：我们收到了你的提案，等待最终的批准。而 A1 在收到 2 份回复后，就可以发布最终的决议：税率定位 10%，不用再讨论了。
  - 2 份回复就可以确定：包括他自己，就达到 3 个人了，少数服从多数（鸽笼原理｜抽屉原理）
*  A1 提出 10% 税率提案的同时, A5 决定将税率定为 20%：A1 草案将由 4 位侍从送到 A2-A5 那里。但是侍从不靠谱（代表分布式环境不靠谱），负责 A2 和 A3 的侍从顺利送达，而负责 A4 和 A5 的侍从则开溜了，A5 草案则送到了 A4 和 A3 手中。A3 同时收到了 A1 和 A5 的请求，不同的抉择将会导致不同的结果
  - A1 的提案先送到 A3 那里，并且 A3 接受了该提案并回复了侍从，再加上 A2 构成了多数派，成功确定了税率为 10%。
  - 时间和提案者的权势就构成了给提案编号的依据：在决议成型之前收到了 A1 与 A5 的提案。这时协议根据 A5 的身份地位有两种处理方式
    + 当 A5 地位很高，例如 CEO，就回复 A5：已收到您的提案，等待最终批准，但是您之前有人提出将税率定为10%,请明察
    + 当 A5 没地位，普通码农一个，直接不回复。等待 A1 广播：税率定为 10%
  - A1 和 A5 同样提出上述提案，这时 A1 可以正常联系 A2 和 A3，A5 也可以正常联系这两个人。 A2 先收到 A1 的提案; A3 则先收到 A5 的提案。而 A5 更有地位
    + 已经回答 A1 的 A2 发现有比 A1 更有权势的 A5 提出了税率 20% 的新提案，于是回复A5说：我已收到您的提案，等待最终批准。
    + 回复 A5 的 A3 发现提案者A1是个小人物，没地位不予应答
    + A5 得到了 A2，A3 的回复，于是 A5 说：税率定为 20%，别再讨论了。

## 死锁

* 根本原因在于两个proposer交替提案
* 解决
  - 如果一个proposer通过accpter返回的消息知道此时有更高编号的提案被提出时，该proposer静默一段时间，而不是马上提出更高的方案，静默期长短为一个提案从提出到被接受的大概时间长度即可，静默期过后，proposer重新提案。
  - 系统中之所以要有主proposer的原因在于，如果每次数据更改都用paxos，那实在是太慢了，还是通过主节点下发请求这样来的快，因为省去了不必要的paxos时间。
  - 所以选择主proposer用paxos算法，因为选主的频率要比更改数据频率低太多
  - 主proposer挂了咋整，整个集群就一直处于不可用状态，所以一般都用租约的方式，如果proposer挂了，则租约会过期，其它proposer就可以再重新选主，如果不挂，则主proposer自己续租。
