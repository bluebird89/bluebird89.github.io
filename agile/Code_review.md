# 代码审查

一项确保软件质量的活动，是由一个或多个人通过查看和阅读部分源代码来检查程序的一种方式，代码审查通常发生在实现完成后或实现中间阶段。参与审查的人员中必须至少有一人不是代码的作者。执行审查的人员称之为“审查人”，但不包含作者本人

* 团队成员聚在一起共同学习，而不是相互“挑错”
* 学习重点是团队成员共同识别模式。代码的作者就不是重点。在代码回顾的过程中，完全可以不提谁是代码的作者，而只提“好模式”和“反模式”，这样能让作者放松心态，更好地接受合理的建议
  - 好模式
  - 反模式
* 提高代码质量
* 代码可以更好的组织起来，有更易读，有更高的维护性，同时可以达到知识共享
* 保持项目一致性
* 重在识别编程习惯，而不是找bug
* 学习（通过代码被审查）和教学（通过审查其他人的代码）
* 营造共同的责任感
* 通过他方查找代码中的小错误，防止这些小错误日积月累腐蚀代码
* 寻找更好的解决方案的常见方法

## 没有效果

* 人员能力不足:不知道什么是好的代码，什么是不好的代码
  - 代码风格这种事，是每个程序员自查的事情，不应该浪费大家的时间。对此建议
    + 团队的人招错了，该换血了
    + 让你团队的人花时候阅读一下《代码大全》这本书
* 结果更重要:急功近利，也许做得多，拿到了不错的年终奖，但是失去了成为一个卓越工程师的机会
* 人员的态度问题
  - 懒，不想精益求精，只要干完活交差了事
  - 团队里这样的“各个自扫门前雪”的事越多，那么这个团队也就越没主动性
* 需求变化问题
  - 重新定义产品主要目标和范围，确定哪些该做，哪些不该做
  - 制定标准 ，让阿里云的API都长得基本一样，并制订云资源的接入标准
  - 推动重构阿里云的Portal系统，不再实现阿里云已经做过的东西，与阿里云紧密结合
* 时间不够问题
  - 减少需求,让产品的目标和方向更明确,有时间充电去学技术，并为聚石塔思考未来的方向和发展
  - 需求管理
    + 去Review业务部门给的需求，哪些是合理的，哪些是不合理的:在Amazon,开发工程师都会被教育拿到需求后一定要问——“为什么要做？业务影响度有多大？有多少用户受益？回答不清这个问题，没有数据的支持，就不做.所以，产品经理要做很多数据挖拙和用户调研的工作
    + 产品经理也要管理和教育的。要告诉产品经理：“你是一个好的产品经理，因为你不但对用户把握得很好，也会对软件工艺把握得很好。你不但会开出外在的功能性需求，也同样会开出内在的让软件系统更完善的非功能性需求。你不是在迁就用户，而是引导用户。你不会无限制地加功能，而是把握产品灵魂控制并简化功能。你会为自己要做的和不做东西的感到同样的自豪。”你要告诉你的产品经理：“做一个半成品不如做好半年产品
    + 做事情是要讲效率的。Amazon里喜欢使用一种叫T-Shirt Size Estimation的评估方法来优先做投入小产出大的“Happy Case
    + 需求总是会变化的，不要抱怨需求变化太快。你应该抱怨的是为什么我们没有把握好方向？老变
  - 项目管理
* 对自己负责就是，用脚投票，如果妥协得受不了了就离开吧

## 被审查者

* 代码审查不是为了评判或审查某个人的编程能力。“代码审查只关注代码”
* 避免
  - 将重构的代码和新代码的实现混合在一起
  - 在提交功能变更时，重新格式化整个代码库
  - 提交代码时不写提交注释（我会在后面讨论该话题）
  - 在一次代码审核（或一次代码提交）中提交多个功能
  - 即使代码本身已经符合整洁代码的要求，他们也会不自觉地提出自己的不同写法，甚至会提出另一种全新的设计
* 注意
  - 单独提交代码清理命令（重新格式化或修复拼写错误等）和重构:代码是否与提交注释相符
  - 编写相关的提交说明
  - 只提交准备好审查的代码
  - 审查期间不要更改代码
  - 确保你的代码通过了自己的审查，并且你没有发现任何明显的问题，可以放心地合并代码（如果你发现了问题，并想讨论某些内容，那么提前跟你的审核者打招呼）；
  - 代码中没有混合不相干的变更，不会太长也不会增加阅读难度；
  - 针对代码变更写好提交注释，明确交待变更的目的
* 快速完成功能，大家写代码的时候都没有思考太多 =》 自己的代码马上就要被别人审视， 就像开源软件一样，写得小心翼翼了

```
XXX：添加一些新功能（简短的说明）

对于代码实现更为详细的描述
可以写很多行，但还可以包括：
* 项目符号
* 不同的细节
* 如果你有很多点，一行写不下，那么也可以在各个点之间插入空行

引用与之相关的问题
```

## 审查者

* 性能（如果是在同一个代码库的话，通常不那么重要）
* 可读性（恕我直言，这几乎是最重要的）
* 尝试覆盖比被审查的解决方案更多的极端情况
* 是否可以用更好的代码样式（比如更多可重用的代码）来实现相同的功能
* 代码测试
  - 验证它们是否在测试正确的东西
  - 变更后的 API 的使用方法以及测试用例是否合理。
  - 通过单元测试我们就能看出实现的使用方法。
* 安全：代码都需要拥有某种安全机制（例如 OAUTH 层，或 REST 控制器的 BASIC
* 保持友好
* 审查代码，而不是写代码的人
* 评语要简洁准确
* 在最后不要忘了为好的代码点赞
* 表明你是否需要等代码修改完毕后再看一次（如果你们的审查工具不支持这一功能的话）

## QA评审底层测试

* QA评审底层测试的价值体现：
  - 最重要的是利用QA的测试技能，可以发现Dev所写底层测试可能存在的问题，让测试更有效。
  - QA通过review底层测试，能够更好的了解测试覆盖情况，更清楚整体的测试状态。
  - QA看Dev写的测试，可以起到督促他们编写测试的作用。
* 对Dev要求：
  - 自己要能清晰理解所有的测试，比如换人结对后，可能对原来同学写的测试没有搞清楚，当然没办法给QA讲清楚；
  - 能清晰的介绍所写测试，包括对应的测试点、哪些点在单元测试覆盖、哪些在集成测试覆盖等；
  - 要能系统的给QA去演示，不是直接打开IDE让QA自己去看，也不是东一个西一个想起哪个给演示哪个，把QA搞晕了。
* 从QA的角度，要想把测试搞清楚，有下面几个要求：
  - 对测试分层等测试策略的理解，需要能够判断出哪些应该写单元测试、哪些写集成测试；
  - 对于底层代码结构的理解，了解单元测试和API集成测试的实现形式，倒不一定要自己去实现，只是要做到能看懂能理解。
  - 对于测试点的把握，比如对所验收用户故事的测试点要做到心中有数，能够清楚的知道需要有哪些测试来覆盖，帮助发现是否有遗漏的测试。
  - 还有就是一些基本测试编写技巧的掌握，比如说测试命名、测试验证点是否正确、测试是否有冗余等。
  - 如果QA对于技术实现不是很了解，可以加强与Dev的沟通，让Dev帮忙介绍更多的上下文以帮助更好的理解。因此，对主动性和沟通能力都有要求。

## 形式

* 每日持续进行，因为只有这样，才能持续改进团队的代码编写水平
* 要像上面讲的那样，不“审、查、评”，不针对作者去找bug，来去除“挑错”的紧张气氛，营造“识别模式”来“共同学习”的环境，吸引团队成员长期参与
* 需要将每日代码回顾的时间控制在半小时以内。因为代码回顾的重点是识别模式，而模式就是习惯，习惯在很少的代码中就能体现出来
* 每日的代码回顾仅需要在半小时内大家一起看200～300行随机抽取的当天编写的代码就够了
* 实践
  - 团队7～8位程序员，下班前半小时聚在会议室里，在一位主持人的引导下做代码回顾；
  - 主持人问：“咱们今天回顾哪段新写的代码？”一位志愿者在投影仪上调出今天编写的一段代码的新旧对比图；
  - 主持人说：“我们知道，如果代码编写得好，那么不是作者的人就能在没有作者帮助的情况下读懂。我希望一位不是这段代码作者的志愿者，来为大家解释一下这段代码是做什么的。”一位非作者的志愿者上来逐行解释代码，并回答大家的疑问。
  - 主持人等代码解释完后，问大家：“这段代码大家还有看不懂的地方吗？”如果有问题，包括作者在内的参会者都可以回答问题，但大家都不提谁是作者。
  - 大家都看懂代码后，主持人问：“大家说说这段代码有没有好的编写模式咱们可以继续发扬？”最初几次代码回顾，好的模式很少。但是即使这样，也一定要找出一些好模式，比如“缩进很好”，“花括号的位置放得很好”，诸如此类。以后几次代码回顾，要尽量找那些被改正过来的曾经的反模式，比如“这段代码用到了方法提取，且命名富有表达力，改掉了昨天’长方法’的反模式”。只识别反模式，不识别好模式，会让代码回顾退化到令人生畏的代码审查，打掉大家长期坚持的积极性。
  - 提完了好模式，主持人问：“大家说说这段代码有没有可以改进的反模式？”大家开始提反模式，注意不要提谁是作者。
    主持人在整个过程中注意计时，快到半小时的时候，可以这样结束代码回顾：“今天时间也快到了，代码回顾的重点在识别模式，而不是看全部的代码。希望大家继续发扬今天识别到的好模式，另外在明天代码回顾时，把今天识别到的反模式改进为好模式。”

##  LinkedIn 相关实践

* 从 2011 年开始，强制要求在团队成员之间做代码复查。Code Review 带来的反馈意见让团队成员能够迅速提升自己的技能水平，这解决了 LinkedIn 各个团队近年来因迅速扩张带来的技能不足的问题
* 建立公司范围的 Code Review 工具，这就可以做跨团队的 Code Review。既有利于消除 bug，提升质量，也有利于不同团队之间经验互通
* Code Review 的经验作为员工晋升的参考因素之一
* 一个难点:Reviewer 可能不了解某块代码修改的背景和目的。所以要求代码签入版本管理系统前，就对其做清晰的说明，以便复查者了解其目的，促进 Review 的进行
  - 个人经验:写文档的时候通常会发现自己把事儿干复杂了，应该把代码再简化一下，于是就会回头去改代码。是的，写文档就是在写代码
* 工具允许提出“这段代码很棒”之类的话语，以便让好代码的作者得到鼓励。我认为，这个方法也很赞，正面鼓励的价值也不可小看
* 为 Code Review 的结果写出有目的性的注释。比如“消除重复代码”，“增加了测试覆盖率”，等等。长此以往也让团队的价值观得以明确
* 不但要 Review 提交者的代码，还要 Reivew 提交者做过的测试。除了一些单元测试，还有一些可能是手动的测试。提交者最好列出所有测试过的案例。这样可以让 Reviewer 可以做出更多的测试建议，从而提高质量
* 对 Code Review 有明确的期望，不过分关注细枝末节，也不要炫技，而是对要 Review 的代码有一个明确的目标

## 方法

* CheckStyle
* Check List
* 小步快跑：控制每次Review代码的数量

## 工具

* Phabricator
* ReviewNinja
* Codacy
* RhodeCode
* Gerrit
* [reviewdog](https://github.com/reviewdog/reviewdog):dog Automated code review tool integrated with any code analysis tools regardless of programming language https://medium.com/@haya14busa/reviewdog-a-code-review-dog-who-keeps-your-codebase-healthy-d957c471938b#.8xctbaw5u

