# 支付

## 支付网关

### 功能

* 核心功能
	* 面向最终用户的支付功能
		* 包括支持的银行、卡机构、第三方支付等的种类和数量，以及支付成功率、支付处理速度、系统稳定性等技术指标。
		* 越大的支付网关，其银行和第三方支付种类覆盖范围就越广，技术更可靠，而收费也更高，且对于本地小银行的支持有限。
		* 如果是本地业务，最好选择一个品牌信誉好的、对本地银行业务支持更加友好的中小规模的支付网关，甚至只提供当地最流行的第三方支付就足够了。在前期的代码设计上，应该预先做好设计与隔离，为更换国际支付做好准备
		* 如果业务或用户涉及国外，则需要了解不同国家和地区的用户支付习惯，提供用户喜爱的本地化支付方式。此时，建议选择一个将各个地区主流第三方支付打包到一起的支付网关，这样可以一次集成，多次应用。
	* 面向商家的收单服务
		* 由于法律监管和银行业务的要求，如果商家需要通过电子支付的方式来收款，需要在收单行开设一种特殊的银行账户：商家账户。
		* 支付网关面向商家提供收单服务，以大大降低商家与银行的谈判、申请账户、以及出问题后多方之间巨大的沟通成本。
		* **建议优先选择支付网关的收单服务**。这样，作为商家只需要跟支付网关一家打交道即可，从流程、技术、沟通等各方面，都省去了很多麻烦。
* 增值功能包含为支持一个完整的业务而提供的各种支撑功能,比如预授权，退款，取消支付，批量支付，定时自动支付，动态货币转换，多货币定价，报表，查询等。
* 作为商家注意点
	*  不仅要看支付网关官网承诺的各项技术指标，还要与其签订明确的SLA以保护自己的权益
 	*  在自己的系统中添加有效的监控和日志，出问题时可以提供足够有价值的信息协助支付网关一起排查定位问题
  	*  对支付网关的接口稳定性进行测试，以及时发现支付网关的故障，从而采取相应措施
 	*  实现一套合理的fallback机制，比如及时隐藏出问题的支付网关、切换到另一种支付网关或第三方支付等，以降低其对业务和用户的影响

### 安全

* PCI DSS（Payment Card Industry Data Security Standard）
	- 由支付卡产业安全标准委员会制定的第三方支付行业数据安全标准，从信息安全管理体系、网络安全、物理安全、数据加密等方方面面提出了一套保护持卡人数据的技术和操作的基线要求。
	- PCI DSS会对支付网关等提供支付服务的机构进行年审，审计结束后，会对被认证企业提供相应的安全级别资质证明。
	- 支付网关的PCI安全认证资质证明可以作为证明其在技术、基础设施和流程等方面安全程度的最有力证明。我们在选择时，**仔细审查其PCI安全级别资质证明即可**。
* 3D Secure Three-Domain Secure
	- 国际卡组织为提高信用卡网上支付的安全性，向卡持卡人推出的一项安全验证服务。它规定，在使用信用卡进行支付时，必须输入支付密码、手机验证码等只有持卡人自己才知道的信息，以验证用户身份。
	- 对商家来说，3DS是一把双刃剑。如果使用了3DS，则意味着对持卡人身份更可靠的验证，如果未来发生投诉退单，其成本会由发卡行而不是商家来承担；但是由于在支付流程中需要跳转到发卡行的网站进行身份验证，从用户体验和技术上都会造成一定支付转换率的损失；同时，商家也需要为额外这一层安全保障付出成本。在某些国家或地区（比如欧洲），各大银行、支付网关和商家必须支持3DS已经是支付领域的法律要求。
	- 建议选择支持3DS功能的支付网关，并将其作为必选项提供给您的用户**。不仅在现在和将来排除了法律风险，也是最有效的防支付诈骗的手段，同时可以为支付诈骗发生后做风险管理和转移提供有力证据。
* 信用卡反欺诈（Fraud Detection）
	- 通过技术手段在支付发生前对可疑情况进行过滤，以降低支付诈骗率。最常见的一个场景，如果反欺诈系统检测到同一个IP地址在短时间内尝试使用不同卡号付款且大部分都会验证失败，则快速做出判断，认为该IP涉嫌诈骗，从而禁止所有该IP的后续请求。
	- 在维护支付网关的项目上，处理最多的问题就是那些因为没有使用反欺诈服务而被攻击的客户，一般遇到这种情况，来自该商家所有用户的支付请求都会被临时禁止直到攻击停止，这对正常业务会产生很大影响。**因此，建议您不要吝啬投入，务必选择一个能提供有效反欺诈能力的支付网关或专业的反欺诈服务提供商**。
* 支付标记化（Tokenization）
	- 由国际芯片卡标准化组织于2014年正式发布的一项技术，其原理是：支付网关在第一次验证完用户身份后，针对每个银行卡号生成一个唯一的token并返回给商家，作为后续支付过程中代表该卡信息的凭证，这样就避免了频繁输入卡信息带来的风险。
	- 如果您的用户主要使用信用卡进行支付，那么我们建议您选择提供支付标记化功能的支付网关**，这样可以允许用户使用保存的卡信息进行支付，可以大大提高忠实用户的用户体验。对于支付标记化的考察，重点需要考察背后的卡信息是否存储在支付网关自己的数据库，如果是，则需要确定其是否满足PCI Level 1的标准。

### 集成方式

* Hosted Payment Page:当用户在商家网站确认订单并点击“继续支付”的按钮后，浏览器会直接从商家网站跳转到由支付网关提供的支付页面，在此页面输入卡信息并进行支付。
* In-Context Popup:当用户在商家网站确认订单并点击“继续支付”的按钮后，直接在当前页面弹出一个由支付网关提供的支付模块弹出框，用户可以在不离开商家网站的情况下进行支付。最典型的例子就是 PayPal in-context checkout 。
* iFrame:支付网关将包含输入卡信息和支付按钮的部分提取成一个公共组件，允许商家在渲染支付页面的时候通过iFrame的形式将该支付组件加载到页面中。
* API:当用户在商家网站输完支付信息、点击支付按钮后，直接从商家网站的后端发送API请求到支付网关。
* 选择
	* 对于有能力满足PCI DSS、有一定技术能力来集成API的商家，用户体验最佳的API集成方式是最佳的选择；
	* 对于希望完全在PCI监管之外，或者希望以最快的速度提供支付功能，而对用户体验要求不太高的商家，Popup 或 Hosted Payment Page 是不错的选择
	* 对于大部分商家来说，iFrame 由于不仅能帮商家规避PCI，同时具备较好的用户体验和较快的集成速度，是大部分场景的最优选择

## 付款码付款

* 支付金额有输入和确认两步，需要双方交互
* 客户扫描商家收款码
  - 输入金额（确认）
  - 支付
* 商家扫描客户付款码：支持离线
  - 商家端获取 付款码（「其实就是一串数字」），然后后台调用支付宝支付接口完成扣款
    + 客户端在线:可以通过服务端向客户端发送付款码
    + 客户端没网:通过客户端通过一定算法生成付款码，服务端收到经过相关校验，确认是哪个用户，确认码有效性，并且完成扣款
  - 商家输入金额（确认）
  - 付款码是否支持本地更新
  - 仅仅传递一个付款码(包含相应的用户信息)，就可以向相应的用户扣款
  - 劣势
    + 算法调整不灵活，如果相关算法较大的调整，可能需要升级客户端,并且这个期间服务端还需要兼容新老算法产生的付款码
    + 安全性问题，正常的情况相关密钥无法被普通用户获取，但是架不住有有心之人。他们可能通过获取手机用户 Root 权限或者越狱手机，利用恶意程序获取密钥，然后随意生成付款码
    + 数据碰撞问题

## 平台

* 支付宝
* 微信
* 运通
* 万事达
* VISA
* [Stripe](https://stripe.com/docs)

## 方案

* [invoiceninja](https://github.com/invoiceninja/invoiceninja):Invoices, Expenses and Tasks built with Laravel and Flutter <https://invoiceninja.com/>
* [xpay](https://github.com/Exrick/xpay):XPay个人免签收款支付系统 完全免费 资金直接到达本人账号 支持 支付宝 微信 QQ 云闪付 无需备案 无需签约 无需挂机监控APP 无需插件 无需第三方支付SDK 无需营业执照身份证 只需收款码 搞定支付流程 现已支持移动端支付 <http://xpay.exrick.cn/>

## 参考

* [离线支付](https://mp.weixin.qq.com/s/tUbCNJeRebxP0ZwiSGknNg)
