# Ad

* 定义：广告主以付费方式通过互联网平台向用户传播商品或者服务信息的手段
* 核心:平衡
  - 广告主：关注ROI，花了钱是否能带来预期收益
  - 平台：拥有流量，关注收益能否最大化.站在平台的角度来看广告业务，它在保证用户体验的同时，要兼顾绝大部分广告主的ROI（确保他们是可以赚到钱的），在此基础上再考虑将平台的收入最大化，这样才是一个健康的广告生态。
  - 用户：关注体验，广告是否足够精准？是否影响到了正常功能的使用？
* 初期一般都是采用「自营的竞价广告网络」来实现商业变现，简单理解：就是利用平台自有的流量以及自主开发的广告主来实现业务闭环.随着平台流量以及广告主规模进一步增大，往往会从「自营型竞价网络」逐渐向「联盟广告以及RTB实时竞价」方向发展，类似于阿里妈妈、腾讯广点通、头条巨量引擎

## 术语

* 广告售卖方式
  * CPA:Cost Per Action，按照行为计费（比如下载、注册等）
  * CPC Cost Per Click，按点击收费
  * CPD Cost Per Day，按天收费
  * CPI:Cost Per Action，按安装收费
  * CPL:Cost Per Leads，按搜集潜在客户名单数量收费
  * CPM：按照每千次曝光计费
  * CPT：按时间计费，独占性包时段包位置
  * CPS Cost Per Sale，按成功销售数量收费
  * CTR:Click Through Rate 广告点击率 = 点击量/展示量
  * CVR:Click Value Rate 点击转化率 = 转换量/点击量
  * DSP:Demand Side Platform，需求方平台。 简介：为广告主服务的平台，广告主可以在平台上设置目标受众、投放区域、广告出价等
  * SSP Supply Side Platform，供应方平台。简介：是一个媒体服务平台，站长们可以在平台上管理自己的广告位，刊例，库存等
  * Ad Exchanges 广告交易系统：为广告主，为媒体提供交易的一个平台，保证每个广告位的价值最大化
  * RTB Real Time Bidding，实时竞价
  * DMP Data Management Platform，数据管理平台。简介：所有涉及广告库存购买和出售的各方管理其数据、所有日志数据的管理
  * PV Page View，页面浏览量
  * UV Unique Visitor，用户去重后总量
  * DAU Daily Active User，日活跃用户数量
  * MAU Monthly Active User，月活跃用户量

## 业务流程

* 广告主先通过投放平台发布广告，可设置一系列的定向条件，比如投放城市、投放时间段、人群标签、出价等。
* 投放动作完成后，广告会被存放到广告库、同时进入索引库，以便能被广告检索引擎召回。
* C端请求过来后，广告引擎会完成召回、算法策略、竞价排序等一系列的逻辑，最终筛选出Top N个广告，实现广告的千人千面。
* 用户点击广告后，会触发广告扣费流程，这时候平台才算真正获得收益。

![广告的核心业务流程](../_static/ad_flow.jpeg"Optional title")

## 效用

* 效果较难衡量的品牌广告，而精打细算的效果广告抗周期性要更强一些
* 当经济不够景气时，广告主首先收缩的是ROI较难衡量的品牌广告预算，而效果广告预算受影响程度会相对小一些
* 腾讯已经在收入的压力下开始朋友圈第三条广告的测试了
* 效果广告的一个重要逻辑是竞价，竞价的前提是有足够的广告主来竞争才能将ECPM维持在有利可图的水平，而要吸引足够的广告主需要有足够大的盘子，否则就只能廉价地把流量卖给广点通等第三方，失去定价权。
* 当百度搜不到淘宝的商品、搜不到美团的吃喝玩乐、搜不到公众号的热文、搜不到出轨的明星和抖音的小姐姐的时候，百度在移动时代的护城河就捉襟见肘了，当网站重要性越来越低的时候，百度的解决方案是再造内容生态——重金扶持爱奇艺、百家号、好看视频，而这一领域的玩家可不像搜索业务一样可以自己定义游戏规则，百度需要在新的业务领域挑战头条、腾讯，于是，把信息流业务做起来的沈抖就成为百度开辟新战场的人选。

## 技术挑战

* 高并发：广告引擎和C端流量对接，请求量大（平峰往往有上万QPS），要求实时响应，必须在几十毫秒内返回结果。
* 业务逻辑复杂：一次广告请求，涉及到多路召回、算法模型打分、竞价排序等复杂的业务流程，策略多，执行链路长。
* 稳定性要求高：广告系统直接跟收入挂钩，广告引擎以及计费平台等核心系统的稳定性要求很高，可用性至少要做到3个9。
* 大数据存储和计算：随业务发展，推广数量以及扣费订单数量很容易达到千万甚至上亿规模，另外收入报表的聚合维度多，单报表可能达到百亿级别的记录数。
* 账务的准确性：广告扣费属于金融性质的操作，需要做到不丢失、不重复，否则会损害某一方的利益。另外，如果收入数据不准确，还可能影响到业务决策。

## 系统

* 广告投放系统：供广告主使用，核心功能包括会员续费、广告库管理、设定推广条件、设置广告出价、查看投放效果等。
* 广告运营后台：供平台的产品运营使用，核心功能包括广告位管理、广告策略管理、以及各种运营工具。
* 广告检索平台：承接C端的高并发请求，负责从海量广告库中筛选出几个或者几十个广告，实时性要求高，这个平台通常由多个微服务组成。
  - 做好服务分层，各层均可水平扩展。
  - 采用Redis缓存，避免高并发请求直接打到数据库，缓存可按业务规划多套，进行分流。
  - 采用多线程并行化某些子流程，比如多路召回逻辑、多模型打分逻辑。
  - 热点数据进行本地缓存，比如广告位的配置信息以及策略配置信息，在服务启动时就可以预加载到本地，然后定时进行同步。
  - 非核心流程设置超时熔断走降级逻辑，比如溢价策略（不溢价只是少赚了，不影响广告召回）。
  - 和主流程无关的逻辑异步执行，比如扣费信息缓存、召回结果缓存等。
  - 精简RPC返回结果或者Redis缓存对象的结构，去掉不必要的字段，减少IO数据包大小。
  - GC优化，包括JVM堆内存的设置、垃圾收集器的选择、GC频次优化和GC耗时优化。
* AB实验平台：广告业务的稳定器，任何广告策略上的调整均可以通过此平台进行灰度实验，观察收入指标的变化。
* 广告计费平台：面向C端，负责实时扣费，和收入直接挂钩，可用性要求高。并发高、数据量大、同时可用性要求高，需要做到不少扣，不重复扣
* 账务管理中心：广告业务中的财务系统，统管金额相关的业务，包括充值、冻结、扣费等。
* 大数据平台：整个广告系统的底盘，需要聚合各种异构数据源，完成离线和实时数据分析和统计，产出业务报表，生产模型特征等。

## 反作弊

* 作弊：广告有很多的利益方，经常会遇到欺骗性的展示与点击行为。
* 行为几种情况
  - 媒体作弊： 为了获得更高的受益，可能会出现作弊的行为。
  - 广告平台作弊： 为了获得更高的分成，可能出现作弊的行为。
  - 广告主竞争对手作弊： 为了消耗竞争对手的预算，降低竞争对手的广告效果，可能出现作弊的行为。
* 通过数据日志判断是否为作弊行为
  - 广告访问IP分布异常： 发现某几个IP产生大量的点击或者曝光数，这几个IP则存在作弊嫌疑。
  - 广告来源(Referer)异常： 点击或者曝光的Referer页面，如果大量来源集中在某一页面，且不是广告所在的Web页面，那么 Referer 页面，可能有作弊的嫌疑。
  - 广告CTR异常： 虚拟点击或恶意点击，导致 Click/PV 过高比例，或者起伏很大，那么存在作弊的嫌疑。
  - 广告点击没有对应的曝光请求： 如果广告同时监测了曝光和点击，在同时段内存在点击日志却不存在曝光日志，那么存在作弊的嫌疑。
  - 广告访问时间分布异常/规律： 例如每分钟或每小时定时出现在点击/曝光日志中，或者连续点击/曝光的发生时间的间隔过于规律，那么存在作弊的嫌疑。
  - URL，访问者指纹信息(浏览器，操作系统等)异常： 例如大量的点击或者曝光数，都来自于同一版本的浏览器或操作系统，或者占比过高，那么存在作弊的嫌疑。
* 流量劫持：就是在无权投放广告的地方强行投放，或改变广告创意甚至落地页的内容。一般来说，只有一些网络底层服务的提供商，如 DNS、CDN、电信运营商等，才有能力进行劫持。
  - 情况一：当去输入某一个网站地址的时候，后面会自动参数进行跳转。
  - 情况二：就是常见的右下角广告（不是网站正常投放的广告）。
  - 情况三：手机访问网页的时候，运营商会根据你的UA（UserAgent）来植入广告。

## 阶段

* 营销逻辑 4C
  - catch（客户）
  - connect（展现接近客户）
  - close（锁住流量，成交）
  - continue（与客户持续的联系）
* 阶段
  - 劈开脑海（先被大家看见，最好能记住，不一定是一次就能成功）
  - 重复记忆（不断的在用户心智中强化第一次见到的印象，多次重复，重复的有逻辑）

## 平台

* [新抖](https://xd.newrank.cn/)

## 参考

* 《计算广告》
* 《互联网广告反作弊技术白皮书》

## 工具

* [pi-hole](https://github.com/pi-hole/pi-hole):A black hole for Internet advertisements <https://pi-hole.net>
* [AdGuardHome](https://github.com/AdguardTeam/AdGuardHome):Network-wide ads & trackers blocking DNS server <https://adguard.com/adguard-home.html>
